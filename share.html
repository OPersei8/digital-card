<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.3.0/sdk.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
        
        <script>
            var cards = []
            console.log("here1")
            window.onload = () =>{
                console.log("here2")
                let urlParams = new URLSearchParams(window.location.search);
                let val = urlParams.get('index');
                liff
                .init({
                    liffId: "1655456623-oxjPwXjM"
                })
                .then(() => {
                    if (!liff.isLoggedIn()) {
                        console.log("here3");
                        debugger;
                        liff.login({ redirectUri: `https://opersei8.github.io/digital-card/share?index=${val}` });
                        // Verify that the domain name and path (https://example.com/path) match the endpoint URL.
                    }
                    getCard()
                    .then(()=>{
                        sendCard(cards.find(emt=>emt.index == val).data)
                        .then(res=>{
                            window.close();
                            liff.closeWindow();
                        })
                    })
                })
                .catch((LiffError) => {
                    liff.closeWindow();
                });
            }

            function getCard(){
                return new Promise((resolve,reject)=>{
                    fetch('./cards.json')
                    .then(res=>res.json())
                    .catch(err=>reject(err))
                    .then(data=>{
                        cards=data.data;
                        resolve();                    
                    });
                })
            }

            function sendCard(val){
                return new Promise((resolve,reject)=>{
                    if (liff.isApiAvailable('shareTargetPicker')) {
                        liff.shareTargetPicker([
                            {
                            "type": "flex",
                            "altText": "數位版名片",
                            "contents": val
                            }
                        ]).then(status=>{
                            resolve();
                        });
                    } else {
                        reject("分享權限未開啟");
                    }
                })
           }
        </script>
    </body>
</html>