<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>分享</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.3.0/sdk.js"></script>
    </head>
    <body>
        若分享視窗沒有出現，請允許顯示彈出視窗並再試一次。
        <div style="font-size:20%">
        </div>
        <script>
            var cards = [];
            window.onload = () =>{
                let urlParams = new URLSearchParams(window.location.search);
                let val = urlParams.get('index');
                liff
                .init({
                    liffId: "1655456623-oxjPwXjM"
                })
                .then(() => {
                    if (!liff.isLoggedIn()) {
                        liff.login({ redirectUri: `https://opersei8.github.io/digital-card/share?index=${val}` });
                        // Verify that the domain name and path (https://example.com/path) match the endpoint URL.
                    }
                    getCard()
                    .then(()=>{
                        sendCard(cards.find(emt=>emt.index == val).data)
                        .then(res=>{
                            window.close();
                            liff.closeWindow();
                        })
                    })
                })
                .catch((LiffError) => {
                    liff.closeWindow();
                });
            }

            function getCard(){
                return new Promise((resolve,reject)=>{
                    fetch('./cards.json')
                    .then(res=>res.json())
                    .catch(err=>reject(err))
                    .then(data=>{
                        cards=data.data;
                        resolve();                    
                    });
                })
            }

            function sendCard(val){
                return new Promise((resolve,reject)=>{
                    if (liff.isApiAvailable('shareTargetPicker')) {
                        liff.shareTargetPicker([
                            {
                            "type": "flex",
                            "altText": "數位版名片",
                            "contents": val
                            }
                        ]).then(status=>{
                            resolve();
                        });
                    } else {
                        reject("分享權限未開啟");
                    }
                })
           }
        </script>
    </body>
</html>